#+TITLE: sync_bidireccional.sh - Sincronizaci√≥n Bidireccional con pCloud
#+AUTHOR: Autom√°tico
#+DATE: Generado el $(date +%Y-%m-%d)

* Descripci√≥n
Script avanzado de sincronizaci√≥n bidireccional entre directorio local y pCloud Drive con capacidades de backup, manejo de enlaces simb√≥licos y sistema de logging.

* Caracter√≠sticas Principales
- Sincronizaci√≥n bidireccional (subir/bajar)
- Manejo de enlaces simb√≥licos
- Sistema de locking para ejecuciones simult√°neas
- Verificaci√≥n de espacio en disco
- Modo dry-run y verbose
- Rotaci√≥n autom√°tica de logs
- Compatibilidad con macOS y Linux
- Soporte para m√∫ltiples configuraciones por hostname
- Notificaciones del sistema al finalizar (Linux/macOS)
- Estad√≠sticas detalladas de rendimiento
- Verificaci√≥n de conectividad con pCloud
- Soporte para m√∫ltiples --item y --exclude
- L√≠mite de tiempo por operaci√≥n (timeout)
- Detecci√≥n autom√°tica de FQDN del host

* Requisitos
- Bash 4.0+
- rsync
- pCloud Drive montado localmente
- Herramientas b√°sicas: grep, awk, find, stat
- Opcional: ~curl~ para verificaci√≥n de conectividad
- Opcional: ~notify-send~ (Linux) o ~osascript~ (macOS) para notificaciones

* Instalaci√≥n
1. Guardar el script en un directorio del PATH
2. Hacer ejecutable:
   #+BEGIN_SRC shell
   chmod +x sync_bidireccional.sh
   #+END_SRC
3. Configurar los archivos de configuraci√≥n (ver secci√≥n Configuraci√≥n)

* Configuraci√≥n

** Archivos de Configuraci√≥n
El script busca estos archivos en el directorio del script o directorio actual:

- ~sync_bidireccional_directorios.ini~ :: Lista principal de elementos a sincronizar
- ~sync_bidireccional_directorios_<hostname>.ini~ :: Configuraci√≥n espec√≠fica por host
- ~sync_bidireccional_exclusiones.ini~ :: Patrones de exclusi√≥n para rsync

** Variables de Entorno
El script usa estas variables configurables:

- ~PCLOUD_MOUNT_POINT~ :: Punto de montaje de pCloud (por defecto: ~$HOME/pCloudDrive~)
- ~LOCAL_DIR~ :: Directorio local a sincronizar (por defecto: ~$HOME~)
- ~LOG_FILE~ :: Archivo de log (por defecto: ~$HOME/sync_bidireccional.log~)

* Uso

** Sintaxis B√°sica
#+BEGIN_SRC shell
sync_bidireccional.sh [--subir|--bajar] [OPCIONES]
#+END_SRC

** Opciones Principales
| Opci√≥n          | Descripci√≥n                                      |
|-----------------|--------------------------------------------------|
| --subir         | Sincroniza local ‚Üí pCloud                       |
| --bajar         | Sincroniza pCloud ‚Üí local                       |
| --delete        | Elimina archivos obsoletos en destino           |
| --dry-run       | Simula sin hacer cambios reales                 |
| --item ELEMENTO | Sincroniza solo el elemento especificado        |
| --yes           | Ejecuta sin confirmaci√≥n                        |
| --backup-dir    | Usa directorio de backup de solo lectura        |
| --overwrite     | Sobrescribe archivos en destino                 |
| --checksum      | Usa checksum para comparaci√≥n (m√°s lento)       |
| --bwlimit KB/s  | Limita velocidad de transferencia               |
| --timeout MIN   | L√≠mite de tiempo por operaci√≥n (default: 30)    |
| --force-unlock  | Fuerza eliminaci√≥n de lock obsoleto             |
| --verbose       | Habilita modo verboso                           |
| --test          | Ejecuta tests unitarios                         |
| --help          | Muestra ayuda detallada                         |

** Ejemplos Comunes

*** Sincronizaci√≥n normal
#+BEGIN_SRC shell
# Subir cambios a pCloud
sync_bidireccional.sh --subir

# Bajar cambios desde pCloud
sync_bidireccional.sh --bajar
#+END_SRC

*** Sincronizaci√≥n con eliminaci√≥n
#+BEGIN_SRC shell
# Subir y eliminar archivos obsoletos
sync_bidireccional.sh --subir --delete --yes
#+END_SRC

*** Sincronizaci√≥n de elemento espec√≠fico
#+BEGIN_SRC shell
# Sincronizar solo un directorio espec√≠fico
sync_bidireccional.sh --subir --item Documentos/ --dry-run
#+END_SRC

*** Sincronizaci√≥n con l√≠mites
#+BEGIN_SRC shell
# Con l√≠mite de velocidad y tiempo
sync_bidireccional.sh --bajar --bwlimit 1000 --timeout 10
#+END_SRC

* Manejo de Enlaces Simb√≥licos
El script gestiona enlaces simb√≥licos mediante un archivo metadato (~.sync_bidireccional_symlinks.meta~) que:
1. Se crea durante la subida con informaci√≥n de enlaces
2. Se usa durante la bajada para recrear enlaces

Los enlaces que apuntan fuera del directorio home se normalizan para usar ~$USERNAME~.

* Sistema de Notificaciones
El script env√≠a notificaciones del sistema al finalizar:
- Linux: mediante ~notify-send~
- macOS: mediante ~osascript~
- Fallback: mensaje en terminal con emoji (üîî)

* Sistema de Locking
El script implementa locking para prevenir ejecuciones simult√°neas:
- Lock file: ~/tmp/sync_bidireccional.lock~
- Timeout autom√°tico: 1 hora
- Forzar desbloqueo: ~--force-unlock~

* Logging y Monitoreo
- Log principal: ~$HOME/sync_bidireccional.log~
- Rotaci√≥n autom√°tica al alcanzar 10MB
- Formatos de mensaje coloreados en terminal
- Estad√≠sticas detalladas al finalizar
- Notificaciones del sistema al finalizar (√©xito/error)

* Troubleshooting

** Error: Punto de montaje no encontrado
Verificar que pCloud Drive est√© instalado y montado en ~$HOME/pCloudDrive~

** Error: Lock existente
#+BEGIN_SRC shell
# Forzar eliminaci√≥n de lock
sync_bidireccional.sh --force-unlock
#+END_SRC

** Error: Espacio insuficiente
El script verifica espacio pero puede necesitar m√°s del estimado

** Error: Sin conectividad
El script verifica conectividad con pCloud. Si falla, se muestra advertencia.

** Modo verboso para debugging
#+BEGIN_SRC shell
sync_bidireccional.sh --subir --verbose --dry-run
#+END_SRC

* Tests Unitarios
Ejecutar tests de validaci√≥n:
#+BEGIN_SRC shell
sync_bidireccional.sh --test
#+END_SRC

* Rendimiento y Optimizaci√≥n
El script incluye varias optimizaciones:
- L√≠mite de bandwidth configurable (~--bwlimit~)
- Timeout por operaci√≥n para evitar bloqueos
- Sincronizaci√≥n con ~--whole-file~ para mejor rendimiento en redes locales
- Modo ~--checksum~ para verificaci√≥n precisa (a costa de rendimiento)

* Limitaciones Conocidas
- No soporta sincronizaci√≥n contin√∫a (solo por ejecuci√≥n)
- El manejo de enlaces simb√≥licos complejos puede fallar
- No comprime datos durante transferencia
- Timeout por operaci√≥n, no global

* Seguridad
- Verificaci√≥n de rutas para prevenir path traversal
- Validaci√≥n de permisos de escritura
- Sanitizaci√≥n de entradas (en desarrollo)
- Verificaci√≥n de que los elementos est√°n dentro del directorio home

* Mantenimiento
El script incluye funcionalidades autom√°ticas de mantenimiento:
- Rotaci√≥n de logs
- Limpieza de archivos temporales
- Verificaci√≥n de dependencias

* Soporte
Para problemas o mejoras, contactar con el mantenedor del script.
