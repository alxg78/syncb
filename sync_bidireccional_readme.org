#+TITLE: sync_bidireccional.sh - Sincronización Bidireccional con pCloud
#+AUTHOR: Automático
#+DATE: Generado el $(date +%Y-%m-%d)

* Descripción
Script avanzado de sincronización bidireccional entre directorio local y pCloud Drive con capacidades de backup, manejo de enlaces simbólicos y sistema de logging.

* Características Principales
- Sincronización bidireccional (subir/bajar)
- Manejo de enlaces simbólicos
- Sistema de locking para ejecuciones simultáneas
- Verificación de espacio en disco
- Modo dry-run y verbose
- Rotación automática de logs
- Compatibilidad con macOS y Linux
- Soporte para múltiples configuraciones por hostname

* Requisitos
- Bash 4.0+
- rsync
- pCloud Drive montado localmente
- Herramientas básicas: grep, awk, find, stat

* Instalación
1. Guardar el script en un directorio del PATH
2. Hacer ejecutable:
   #+BEGIN_SRC shell
   chmod +x sync_bidireccional.sh
   #+END_SRC
3. Configurar los archivos de configuración (ver sección Configuración)

* Configuración

** Archivos de Configuración
El script busca estos archivos en el directorio del script o directorio actual:

- ~sync_bidireccional_directorios.ini~ :: Lista principal de elementos a sincronizar
- ~sync_bidireccional_directorios_<hostname>.ini~ :: Configuración específica por host
- ~sync_bidireccional_exclusiones.ini~ :: Patrones de exclusión para rsync

** Variables de Entorno
El script usa estas variables configurables:

- ~PCLOUD_MOUNT_POINT~ :: Punto de montaje de pCloud (por defecto: ~$HOME/pCloudDrive~)
- ~LOCAL_DIR~ :: Directorio local a sincronizar (por defecto: ~$HOME~)
- ~LOG_FILE~ :: Archivo de log (por defecto: ~$HOME/sync_bidireccional.log~)

* Uso

** Sintaxis Básica
#+BEGIN_SRC shell
sync_bidireccional.sh [--subir|--bajar] [OPCIONES]
#+END_SRC

** Opciones Principales
| Opción          | Descripción                                      |
|-----------------|--------------------------------------------------|
| --subir         | Sincroniza local → pCloud                       |
| --bajar         | Sincroniza pCloud → local                       |
| --delete        | Elimina archivos obsoletos en destino           |
| --dry-run       | Simula sin hacer cambios reales                 |
| --item ELEMENTO | Sincroniza solo el elemento especificado        |
| --yes           | Ejecuta sin confirmación                        |
| --backup-dir    | Usa directorio de backup de solo lectura        |
| --overwrite     | Sobrescribe archivos en destino                 |
| --checksum      | Usa checksum para comparación (más lento)       |
| --bwlimit KB/s  | Limita velocidad de transferencia               |
| --timeout MIN   | Límite de tiempo por operación (default: 30)    |
| --force-unlock  | Fuerza eliminación de lock obsoleto             |
| --verbose       | Habilita modo verboso                           |
| --test          | Ejecuta tests unitarios                         |
| --help          | Muestra ayuda detallada                         |

** Ejemplos Comunes

*** Sincronización normal
#+BEGIN_SRC shell
# Subir cambios a pCloud
sync_bidireccional.sh --subir

# Bajar cambios desde pCloud
sync_bidireccional.sh --bajar
#+END_SRC

*** Sincronización con eliminación
#+BEGIN_SRC shell
# Subir y eliminar archivos obsoletos
sync_bidireccional.sh --subir --delete --yes
#+END_SRC

*** Sincronización de elemento específico
#+BEGIN_SRC shell
# Sincronizar solo un directorio específico
sync_bidireccional.sh --subir --item Documentos/ --dry-run
#+END_SRC

*** Sincronización con límites
#+BEGIN_SRC shell
# Con límite de velocidad y tiempo
sync_bidireccional.sh --bajar --bwlimit 1000 --timeout 10
#+END_SRC

* Manejo de Enlaces Simbólicos
El script gestiona enlaces simbólicos mediante un archivo metadato (~.sync_bidireccional_symlinks.meta~) que:
1. Se crea durante la subida con información de enlaces
2. Se usa durante la bajada para recrear enlaces

Los enlaces que apuntan fuera del directorio home se normalizan para usar ~$USERNAME~.

* Sistema de Locking
El script implementa locking para prevenir ejecuciones simultáneas:
- Lock file: ~/tmp/sync_bidireccional.lock~
- Timeout automático: 1 hora
- Forzar desbloqueo: ~--force-unlock~

* Logging y Monitoreo
- Log principal: ~$HOME/sync_bidireccional.log~
- Rotación automática al alcanzar 10MB
- Formatos de mensaje coloreados en terminal
- Estadísticas detalladas al finalizar

* Troubleshooting

** Error: Punto de montaje no encontrado
Verificar que pCloud Drive esté instalado y montado en ~$HOME/pCloudDrive~

** Error: Lock existente
#+BEGIN_SRC shell
# Forzar eliminación de lock
sync_bidireccional.sh --force-unlock
#+END_SRC

** Error: Espacio insuficiente
El script verifica espacio pero puede necesitar más del estimado

** Modo verboso para debugging
#+BEGIN_SRC shell
sync_bidireccional.sh --subir --verbose --dry-run
#+END_SRC

* Tests Unitarios
Ejecutar tests de validación:
#+BEGIN_SRC shell
sync_bidireccional.sh --test
#+END_SRC

* Limitaciones Conocidas
- No soporta sincronización continúa (solo por ejecución)
- El manejo de enlaces simbólicos complejos puede fallar
- No comprime datos durante transferencia
- Timeout por operación, no global

* Seguridad
- Verificación de rutas para prevenir path traversal
- Validación de permisos de escritura
- Sanitización de entradas (en desarrollo)

* Mantenimiento
El script incluye funcionalidades automáticas de mantenimiento:
- Rotación de logs
- Limpieza de archivos temporales
- Verificación de dependencias

* Soporte
Para problemas o mejoras, contactar con el mantenedor del script.